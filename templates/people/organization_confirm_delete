<!-- templates/people/organization_confirm_delete.html -->
{% extends 'base.html' %}

{% block title %}{{ object.name }}を削除 - {{ block.super }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-3 mb-4">
    <div>
        <h1 class="h2 animate__animated animate__fadeInDown">
            <i class="bi bi-exclamation-triangle text-danger me-3"></i>
            組織削除の確認
        </h1>
        <p class="text-muted animate__animated animate__fadeInUp animate__delay-1s">
            以下の組織を完全に削除します。この操作は元に戻すことができません。
        </p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'organization_detail' object.pk %}" class="btn btn-outline-secondary animate__animated animate__fadeInRight">
            <i class="bi bi-arrow-left me-2"></i> 詳細に戻る
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card animate__animated animate__fadeInUp">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>削除対象組織
                </h5>
            </div>
            <div class="card-body">
                <!-- 組織情報 -->
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <div class="organization-icon mb-3">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center shadow-lg text-white"
                                 style="width: 100px; height: 100px; background: linear-gradient(135deg, 
                                   {% if object.level == 0 %}#dc3545 0%, #fd7e14 100%{% elif object.level == 1 %}#ffc107 0%, #fd7e14 100%{% else %}#17a2b8 0%, #6f42c1 100%{% endif %});">
                                <i class="bi bi-{% if object.level == 0 %}building{% elif object.level == 1 %}diagram-2{% else %}diagram-3{% endif %} fs-1"></i>
                            </div>
                        </div>
                        <h4 class="fw-bold org-level-{{ object.level }}">{{ object.name }}</h4>
                        <p class="text-muted">{{ object.get_level_display }}</p>
                    </div>
                    
                    <div class="col-md-8">
                        <h6>基本情報</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>組織名:</strong></td>
                                <td>{{ object.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>階層レベル:</strong></td>
                                <td>{{ object.get_level_display }}</td>
                            </tr>
                            <tr>
                                <td><strong>親組織:</strong></td>
                                <td>
                                    {% if object.parent %}
                                        {{ object.parent.name }}
                                    {% else %}
                                        なし（最上位組織）
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>完全パス:</strong></td>
                                <td>{{ object.get_full_path }}</td>
                            </tr>
                            <tr>
                                <td><strong>作成日:</strong></td>
                                <td>{{ object.created_at|date:"Y年m月d日 H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- 影響範囲チェック -->
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>削除による影響範囲</h6>
                </div>
                
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="impact-item p-3 border rounded">
                            <h3 class="{% if object.members.count > 0 %}text-danger{% else %}text-success{% endif %} mb-1">
                                {{ object.members.count }}
                            </h3>
                            <small class="text-muted">所属メンバー</small>
                            {% if object.members.count > 0 %}
                                <div class="mt-2">
                                    <span class="badge bg-danger">削除不可</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="impact-item p-3 border rounded">
                            <h3 class="{% if object.children.count > 0 %}text-danger{% else %}text-success{% endif %} mb-1">
                                {{ object.children.count }}
                            </h3>
                            <small class="text-muted">子組織</small>
                            {% if object.children.count > 0 %}
                                <div class="mt-2">
                                    <span class="badge bg-danger">削除不可</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="impact-item p-3 border rounded">
                            <h3 class="text-warning mb-1">
                                {{ object.outgoing_relations.count|add:object.incoming_relations.count }}
                            </h3>
                            <small class="text-muted">組織関係</small>
                            <div class="mt-2">
                                <span class="badge bg-warning">削除される</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="impact-item p-3 border rounded">
                            <h3 class="text-info mb-1">1</h3>
                            <small class="text-muted">組織レコード</small>
                            <div class="mt-2">
                                <span class="badge bg-danger">削除される</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 削除不可の理由 -->
                {% if object.members.count > 0 or object.children.count > 0 %}
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle me-2"></i>削除できない理由</h6>
                        <ul class="mb-0">
                            {% if object.members.count > 0 %}
                                <li>この組織には{{ object.members.count }}人のメンバーが所属しています。先にメンバーを他の組織に移動してください。</li>
                            {% endif %}
                            {% if object.children.count > 0 %}
                                <li>この組織には{{ object.children.count }}個の子組織があります。先に子組織を削除または移動してください。</li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <div class="text-center">
                        <a href="{% url 'organization_detail' object.pk %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-left me-2"></i>組織詳細に戻る
                        </a>
                        <a href="{% url 'organization_edit' object.pk %}" class="btn btn-outline-primary btn-lg ms-2">
                            <i class="bi bi-pencil me-2"></i>組織を編集
                        </a>
                    </div>
                {% else %}
                    <!-- 削除実行フォーム -->
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle me-2"></i>削除実行可能</h6>
                        <p class="mb-0">この組織は安全に削除できます。メンバーや子組織は存在しません。</p>
                    </div>
                    
                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="confirmDeletion" required>
                            <label class="form-check-label" for="confirmDeletion">
                                <strong>確認:</strong> 「{{ object.name }}」を完全に削除することを理解し、同意します。この操作は元に戻すことができません。
                            </label>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'organization_detail' object.pk %}" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle me-2"></i>キャンセル
                            </a>
                            
                            <button type="submit" class="btn btn-danger btn-lg" id="deleteButton" disabled>
                                <i class="bi bi-trash me-2"></i>削除を実行
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmCheckbox = document.getElementById('confirmDeletion');
    const deleteButton = document.getElementById('deleteButton');
    
    if (confirmCheckbox && deleteButton) {
        confirmCheckbox.addEventListener('change', function() {
            deleteButton.disabled = !this.checked;
            
            if (this.checked) {
                deleteButton.classList.remove('btn-secondary');
                deleteButton.classList.add('btn-danger');
            } else {
                deleteButton.classList.remove('btn-danger');
                deleteButton.classList.add('btn-secondary');
            }
        });
        
        // 削除ボタンクリック時の最終確認
        deleteButton.addEventListener('click', function(e) {
            if (!confirm('本当に削除してもよろしいですか？この操作は元に戻すことができません。')) {
                e.preventDefault();
            }
        });
    }
});
</script>

<style>
.impact-item {
    transition: all 0.3s ease;
}

.impact-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}