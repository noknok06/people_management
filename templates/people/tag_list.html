<!-- templates/people/tag_list.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}„Çø„Ç∞ÁÆ°ÁêÜ - {{ block.super }}{% endblock %}

{% block content %}
<!-- CSRF„Éà„Éº„ÇØ„É≥„ÇíÈö†„Åó„Éï„Ç£„Éº„É´„Éâ„Å®„Åó„Å¶ËøΩÂä† -->
<form style="display: none;">
    {% csrf_token %}
</form>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-4 pb-3 mb-4">
    <div>
        <h1 class="h2 animate__animated animate__fadeInDown">
            <i class="bi bi-tags-fill text-primary me-3"></i>
            „Çø„Ç∞ÁÆ°ÁêÜ
        </h1>
        <p class="text-muted animate__animated animate__fadeInUp animate__delay-1s">
            ‰∫∫Áâ©„Å®ÁµÑÁπî„ÅÆÂàÜÈ°û„ÉªÊ§úÁ¥¢„ÇíÂäπÁéáÂåñ„Åô„Çã„Çø„Ç∞„Ç∑„Çπ„ÉÜ„É†
        </p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2 animate__animated animate__fadeInRight">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTagModal">
                <i class="bi bi-plus-circle-fill me-2"></i> Êñ∞„Åó„ÅÑ„Çø„Ç∞„Çí‰ΩúÊàê
            </button>
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importTagsModal">
                <i class="bi bi-upload me-2"></i> „Ç§„É≥„Éù„Éº„Éà
            </button>
        </div>
        <div class="btn-group animate__animated animate__fadeInRight animate__delay-1s">
            <button type="button" class="btn btn-outline-secondary" id="bulkActionsBtn">
                <i class="bi bi-list-check me-2"></i> ‰∏ÄÊã¨Êìç‰Ωú
            </button>
        </div>
    </div>
</div>

<!-- Tag Analytics Dashboard -->
<div class="row mb-5">
    <div class="col-md-3 mb-4">
        <div class="card stats-card text-white h-100 animate__animated animate__fadeInUp">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h2 class="card-title mb-1 fw-bold">{{ tags.count }}</h2>
                                <p class="card-text mb-0">Á∑è„Çø„Ç∞Êï∞</p>
                                <small class="text-light opacity-75">
                                    <i class="bi bi-arrow-up me-1"></i>+{{ new_tags_this_month|default:"0" }} ‰ªäÊúà
                                </small>
                            </div>
                            <div class="text-end">
                                <i class="bi bi-tags-fill fs-1 opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-light" role="progressbar" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stats-card bg-success text-white h-100 animate__animated animate__fadeInUp animate__delay-1s">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h2 class="card-title mb-1 fw-bold" id="activeTags">0</h2>
                                <p class="card-text mb-0">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Ç∞</p>
                                <small class="text-light opacity-75">
                                    <i class="bi bi-person-check me-1"></i>‰ΩøÁî®‰∏≠
                                </small>
                            </div>
                            <div class="text-end">
                                <i class="bi bi-check-circle-fill fs-1 opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-light" role="progressbar" style="width: 60%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stats-card bg-info text-white h-100 animate__animated animate__fadeInUp animate__delay-2s">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h2 class="card-title mb-1 fw-bold" id="totalUsage">0</h2>
                                <p class="card-text mb-0">Á∑è‰ΩøÁî®ÂõûÊï∞</p>
                                <small class="text-light opacity-75">
                                    <i class="bi bi-graph-up me-1"></i>‰∫∫Áâ©„ÉªÈñ¢‰øÇ
                                </small>
                            </div>
                            <div class="text-end">
                                <i class="bi bi-graph-up-arrow fs-1 opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-light" role="progressbar" style="width: 90%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stats-card bg-warning text-white h-100 animate__animated animate__fadeInUp animate__delay-3s">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-palette fs-4 me-2"></i>
                                    <span class="fw-bold">„Ç´„É©„Éï„É´</span>
                                </div>
                                <p class="card-text mb-0">„Ç´„É©„Éº„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥</p>
                                <small class="text-light opacity-75">
                                    <i class="bi bi-circle-fill me-1"></i>Ë¶ñË¶öÁöÑÂàÜÈ°û
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="color-palette">
                                    <div class="color-dot bg-danger"></div>
                                    <div class="color-dot bg-success"></div>
                                    <div class="color-dot bg-primary"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-light" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="card mb-4 animate__animated animate__fadeInUp">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="tagSearch" class="form-label">
                    <i class="bi bi-search me-1"></i>„Çø„Ç∞Ê§úÁ¥¢
                </label>
                <div class="input-group">
                    <input type="text" class="form-control" id="tagSearch" placeholder="„Çø„Ç∞Âêç„ÅßÊ§úÁ¥¢...">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            
            <div class="col-md-3">
                <label for="colorFilter" class="form-label">
                    <i class="bi bi-palette me-1"></i>Ëâ≤„Éï„Ç£„É´„Çø„Éº
                </label>
                <select class="form-select" id="colorFilter">
                    <option value="">„Åô„Åπ„Å¶„ÅÆËâ≤</option>
                    <option value="#007bff" data-color="#007bff">üîµ „Éñ„É´„Éº</option>
                    <option value="#28a745" data-color="#28a745">üü¢ „Ç∞„É™„Éº„É≥</option>
                    <option value="#dc3545" data-color="#dc3545">üî¥ „É¨„ÉÉ„Éâ</option>
                    <option value="#ffc107" data-color="#ffc107">üü° „Ç§„Ç®„É≠„Éº</option>
                    <option value="#6f42c1" data-color="#6f42c1">üü£ „Éë„Éº„Éó„É´</option>
                    <option value="#fd7e14" data-color="#fd7e14">üü† „Ç™„É¨„É≥„Ç∏</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="usageFilter" class="form-label">
                    <i class="bi bi-bar-chart me-1"></i>‰ΩøÁî®Áä∂Ê≥Å
                </label>
                <select class="form-select" id="usageFilter">
                    <option value="">„Åô„Åπ„Å¶</option>
                    <option value="active">‰ΩøÁî®‰∏≠„ÅÆ„Åø</option>
                    <option value="unused">Êú™‰ΩøÁî®„ÅÆ„Åø</option>
                    <option value="popular">‰∫∫Ê∞ó„Çø„Ç∞</option>
                </select>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
                <div class="btn-group w-100">
                    <button type="button" class="btn btn-primary" id="applyFilters">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="clearFilters">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tags Grid -->
<div id="tagsContainer">
    <div class="row" id="tagsGrid">
        {% for tag in tags %}
            <div class="col-md-6 col-lg-4 col-xl-3 mb-4 tag-item animate__animated animate__fadeInUp" 
                 style="animation-delay: {{ forloop.counter0|add:1 }}00ms;"
                 data-color="{{ tag.color }}" data-usage="{{ tag.person_count|add:tag.org_relation_count|add:tag.person_relation_count }}">
                <div class="card tag-card h-100">
                    <div class="card-body position-relative">
                        <!-- Tag Color Indicator -->
                        <div class="position-absolute top-0 end-0 m-3">
                            <div class="tag-color-indicator" style="background-color: {{ tag.color }};"></div>
                        </div>
                        
                        <!-- Selection Checkbox -->
                        <div class="position-absolute top-0 start-0 m-3">
                            <div class="form-check">
                                <input class="form-check-input tag-checkbox" type="checkbox" value="{{ tag.id }}" id="tag{{ tag.id }}">
                                <label class="form-check-label" for="tag{{ tag.id }}"></label>
                            </div>
                        </div>
                        
                        <!-- Tag Header -->
                        <div class="tag-header mb-3 pt-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="tag-icon me-3" style="background-color: {{ tag.color }};">
                                    <i class="bi bi-tag-fill text-white"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0 fw-bold">{{ tag.name }}</h5>
                                    <small class="text-muted">‰ΩúÊàê: {{ tag.created_at|date:"Y/m/d"|default:"N/A" }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tag Description -->
                        {% if tag.description %}
                            <div class="tag-description mb-3">
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    {{ tag.description|truncatechars:80 }}
                                </p>
                            </div>
                        {% endif %}
                        
                        <!-- Usage Statistics -->
                        <div class="tag-stats mb-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-primary mb-0">{{ tag.person_count }}</h6>
                                        <small class="text-muted">‰∫∫Áâ©</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item border-start border-end">
                                        <h6 class="text-success mb-0">{{ tag.org_relation_count }}</h6>
                                        <small class="text-muted">ÁµÑÁπîÈñ¢‰øÇ</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-info mb-0">{{ tag.person_relation_count }}</h6>
                                        <small class="text-muted">‰∫∫Áâ©Èñ¢‰øÇ</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Usage Bar -->
                        <div class="usage-bar mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">‰ΩøÁî®È†ªÂ∫¶</small>
                                <small class="fw-bold">{{ tag.person_count|add:tag.org_relation_count|add:tag.person_relation_count }}</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar" style="width: {% widthratio tag.person_count|add:tag.org_relation_count|add:tag.person_relation_count 50 100 %}%; background-color: {{ tag.color }};"></div>
                            </div>
                        </div>
                        
                        <!-- Tag Preview -->
                        <div class="tag-preview mb-3">
                            <span class="tag-sample" style="background-color: {{ tag.color }};">
                                <i class="bi bi-tag me-1"></i>{{ tag.name }}
                            </span>
                        </div>
                        
                        <!-- Actions -->
                        <div class="tag-actions d-flex justify-content-between align-items-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editTagModal" data-tag-id="{{ tag.id }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="filterByTag('{{ tag.id }}')">
                                    <i class="bi bi-funnel"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="duplicateTag('{{ tag.id }}')">
                                        <i class="bi bi-files me-2"></i>Ë§áË£Ω
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportTag('{{ tag.id }}')">
                                        <i class="bi bi-download me-2"></i>„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteTag('{{ tag.id }}')">
                                        <i class="bi bi-trash me-2"></i>ÂâäÈô§
                                    </a></li>
                                </ul>
                            </div>
                            
                            <div class="usage-indicator">
                                {% if tag.person_count|add:tag.org_relation_count|add:tag.person_relation_count > 0 %}
                                    <span class="badge bg-success">‰ΩøÁî®‰∏≠</span>
                                {% else %}
                                    <span class="badge bg-secondary">Êú™‰ΩøÁî®</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="text-center py-5 animate__animated animate__fadeIn">
                    <div class="mb-4">
                        <i class="bi bi-tags fs-1 text-muted opacity-50"></i>
                    </div>
                    <h4 class="text-muted">„Çø„Ç∞„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</h4>
                    <p class="text-muted mb-4">
                        ÊúÄÂàù„ÅÆ„Çø„Ç∞„Çí‰ΩúÊàê„Åó„Å¶„ÄÅ‰∫∫Áâ©„Å®ÁµÑÁπî„ÅÆÂàÜÈ°û„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ<br>
                        „Çø„Ç∞„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®„Åß„ÄÅÂäπÁéáÁöÑ„Å™Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
                    </p>
                    <button type="button" class="btn btn-primary btn-lg rounded-pill" data-bs-toggle="modal" data-bs-target="#createTagModal">
                        <i class="bi bi-plus-circle me-2"></i>ÊúÄÂàù„ÅÆ„Çø„Ç∞„Çí‰ΩúÊàê
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Bulk Action Bar -->
<div id="bulkActionBar" class="position-fixed bottom-0 start-50 translate-middle-x bg-primary text-white rounded-top-4 px-4 py-3 shadow-lg" style="display: none; z-index: 1050;">
    <div class="d-flex align-items-center gap-3">
        <span class="fw-bold">
            <span id="selectedTagCount">0</span>ÂÄã„ÅÆ„Çø„Ç∞„ÇíÈÅ∏Êäû‰∏≠
        </span>
        <div class="btn-group">
            <button class="btn btn-light btn-sm" id="bulkEdit">
                <i class="bi bi-pencil me-1"></i>‰∏ÄÊã¨Á∑®ÈõÜ
            </button>
            <button class="btn btn-light btn-sm" id="bulkExport">
                <i class="bi bi-download me-1"></i>„Ç®„ÇØ„Çπ„Éù„Éº„Éà
            </button>
            <button class="btn btn-outline-light btn-sm" id="bulkDelete">
                <i class="bi bi-trash me-1"></i>ÂâäÈô§
            </button>
            <button class="btn btn-outline-light btn-sm" id="bulkCancel">
                <i class="bi bi-x-lg me-1"></i>„Ç≠„É£„É≥„Çª„É´
            </button>
        </div>
    </div>
</div>

<!-- Create Tag Modal -->
<div class="modal fade" id="createTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Êñ∞„Åó„ÅÑ„Çø„Ç∞„Çí‰ΩúÊàê
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTagForm">
                    <div class="mb-3">
                        <label for="tagName" class="form-label">„Çø„Ç∞Âêç <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="tagName" placeholder="‰æã: Âñ∂Ê•≠ÈÉ®" required>
                        <div class="form-text">ÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèÁü≠„ÅÑÂêçÂâç„ÇíÊé®Â•®„Åó„Åæ„Åô</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tagColor" class="form-label">Ëâ≤</label>
                        <div class="color-selection">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="color" class="form-control form-control-color" id="tagColor" value="#007bff">
                                <span class="small text-muted">„Ç´„Çπ„Çø„É†Ëâ≤</span>
                            </div>
                            <div class="color-presets">
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #007bff;" data-color="#007bff"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #28a745;" data-color="#28a745"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #dc3545;" data-color="#dc3545"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #ffc107;" data-color="#ffc107"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #6f42c1;" data-color="#6f42c1"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #fd7e14;" data-color="#fd7e14"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #17a2b8;" data-color="#17a2b8"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #20c997;" data-color="#20c997"></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tagDescription" class="form-label">Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ</label>
                        <textarea class="form-control" id="tagDescription" rows="3" placeholder="„Åì„ÅÆ„Çø„Ç∞„ÅÆÁî®ÈÄî„ÇÑÊÑèÂë≥„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">„Éó„É¨„Éì„É•„Éº</label>
                        <div class="tag-preview-area p-3 bg-light rounded">
                            <span class="tag-preview-sample" id="tagPreview" style="background-color: #007bff;">
                                <i class="bi bi-tag me-1"></i>„Éó„É¨„Éì„É•„Éº
                            </span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-primary" id="createTagBtn">
                    <i class="bi bi-plus-circle me-2"></i>‰ΩúÊàê
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Tag Modal -->
<div class="modal fade" id="editTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>„Çø„Ç∞„ÇíÁ∑®ÈõÜ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTagForm">
                    <!-- Similar form structure as create modal -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-primary" id="updateTagBtn">
                    <i class="bi bi-check-circle me-2"></i>Êõ¥Êñ∞
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Tags Modal -->
<div class="modal fade" id="importTagsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload me-2"></i>„Çø„Ç∞„Çí„Ç§„É≥„Éù„Éº„Éà
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">CSV„Éï„Ç°„Ç§„É´</label>
                    <input type="file" class="form-control" id="importFile" accept=".csv">
                    <div class="form-text">
                        „Çø„Ç∞Âêç„ÄÅËâ≤„ÄÅË™¨Êòé„ÇíÂê´„ÇÄCSV„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="updateExistingTags">
                        <label class="form-check-label" for="updateExistingTags">
                            Êó¢Â≠ò„ÅÆ„Çø„Ç∞„ÇíÊõ¥Êñ∞„Åô„Çã
                        </label>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>CSV„Éï„Ç©„Éº„Éû„ÉÉ„Éà:</strong> name,color,description
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-primary" id="importTagsBtn">
                    <i class="bi bi-upload me-2"></i>„Ç§„É≥„Éù„Éº„ÉàÈñãÂßã
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF „Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!token) {
            console.error('CSRF token not found');
            return '';
        }
        return token;
    }

    // Initialize counters
    animateStats();
    
    // Real-time search
    const searchInput = document.getElementById('tagSearch');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterTags();
        }, 300);
    });
    
    // Filter functionality
    document.getElementById('applyFilters').addEventListener('click', filterTags);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    
    function filterTags() {
        const searchTerm = searchInput.value.toLowerCase();
        const colorFilter = document.getElementById('colorFilter').value;
        const usageFilter = document.getElementById('usageFilter').value;
        
        const tagItems = document.querySelectorAll('.tag-item');
        
        tagItems.forEach(item => {
            const tagName = item.querySelector('.card-title').textContent.toLowerCase();
            const tagColor = item.dataset.color;
            const tagUsage = parseInt(item.dataset.usage);
            
            let showItem = true;
            
            // Search filter
            if (searchTerm && !tagName.includes(searchTerm)) {
                showItem = false;
            }
            
            // Color filter
            if (colorFilter && tagColor !== colorFilter) {
                showItem = false;
            }
            
            // Usage filter
            if (usageFilter) {
                switch(usageFilter) {
                    case 'active':
                        if (tagUsage === 0) showItem = false;
                        break;
                    case 'unused':
                        if (tagUsage > 0) showItem = false;
                        break;
                    case 'popular':
                        if (tagUsage < 5) showItem = false;
                        break;
                }
            }
            
            if (showItem) {
                item.style.display = 'block';
                item.classList.add('animate__animated', 'animate__fadeIn');
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function clearFilters() {
        document.getElementById('tagSearch').value = '';
        document.getElementById('colorFilter').value = '';
        document.getElementById('usageFilter').value = '';
        
        document.querySelectorAll('.tag-item').forEach(item => {
            item.style.display = 'block';
        });
    }
    
    // Bulk selection
    const checkboxes = document.querySelectorAll('.tag-checkbox');
    const bulkActionBar = document.getElementById('bulkActionBar');
    const selectedCount = document.getElementById('selectedTagCount');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkSelection);
    });
    
    function updateBulkSelection() {
        const selected = document.querySelectorAll('.tag-checkbox:checked');
        
        if (selected.length > 0) {
            selectedCount.textContent = selected.length;
            bulkActionBar.style.display = 'block';
            bulkActionBar.classList.add('animate__animated', 'animate__slideInUp');
        } else {
            bulkActionBar.style.display = 'none';
        }
    }
    
    // Bulk actions
    document.getElementById('bulkCancel').addEventListener('click', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateBulkSelection();
    });
    
    // Tag creation
    const createTagForm = document.getElementById('createTagForm');
    const tagNameInput = document.getElementById('tagName');
    const tagColorInput = document.getElementById('tagColor');
    const tagPreview = document.getElementById('tagPreview');
    
    // Real-time preview update
    function updatePreview() {
        const name = tagNameInput.value || '„Éó„É¨„Éì„É•„Éº';
        const color = tagColorInput.value;
        
        tagPreview.textContent = name;
        tagPreview.style.backgroundColor = color;
        tagPreview.innerHTML = '<i class="bi bi-tag me-1"></i>' + name;
    }
    
    tagNameInput.addEventListener('input', updatePreview);
    tagColorInput.addEventListener('change', updatePreview);
    
    // Color presets
    document.querySelectorAll('.color-preset').forEach(preset => {
        preset.addEventListener('click', function() {
            const color = this.dataset.color;
            tagColorInput.value = color;
            updatePreview();
            
            // Visual feedback
            document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Create tag - „Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°
    document.getElementById('createTagBtn').addEventListener('click', async function() {
        const submitBtn = this;
        const originalText = submitBtn.innerHTML;
        
        const formData = {
            name: tagNameInput.value.trim(),
            color: tagColorInput.value,
            description: document.getElementById('tagDescription').value.trim()
        };
        
        if (!formData.name) {
            showErrorMessage('„Çø„Ç∞Âêç„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ');
            return;
        }
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‰ΩúÊàê‰∏≠...';
        
        try {
            const csrfToken = getCsrfToken();
            console.log('Sending request with CSRF token:', csrfToken);
            
            const response = await fetch('/api/tags/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify(formData)
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            
            const result = await response.json();
            console.log('Response data:', result);
            
            if (result.success) {
                // „Çø„Ç∞„Çí„Ç∞„É™„ÉÉ„Éâ„Å´ËøΩÂä†
                addTagToGrid(result.tag);
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶„Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                bootstrap.Modal.getInstance(document.getElementById('createTagModal')).hide();
                createTagForm.reset();
                tagColorInput.value = '#007bff';
                updatePreview();
                
                showSuccessMessage('„Çø„Ç∞„Äå' + result.tag.name + '„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ');
                
                // Áµ±Ë®à„ÇíÊõ¥Êñ∞
                updateStatsAfterCreate();
                
            } else {
                showErrorMessage(result.error || '„Çø„Ç∞„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
            
        } catch (error) {
            console.error('Error creating tag:', error);
            showErrorMessage('„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
        } finally {
            // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    function addTagToGrid(tagData) {
        const tagsGrid = document.getElementById('tagsGrid');
        const newTagId = 'tag_' + tagData.id;
        
        const tagHTML = `
            <div class="col-md-6 col-lg-4 col-xl-3 mb-4 tag-item animate__animated animate__bounceIn" 
                 data-color="${tagData.color}" data-usage="0">
                <div class="card tag-card h-100">
                    <div class="card-body position-relative">
                        <div class="position-absolute top-0 end-0 m-3">
                            <div class="tag-color-indicator" style="background-color: ${tagData.color};"></div>
                        </div>
                        
                        <div class="position-absolute top-0 start-0 m-3">
                            <div class="form-check">
                                <input class="form-check-input tag-checkbox" type="checkbox" value="${tagData.id}" id="${newTagId}">
                                <label class="form-check-label" for="${newTagId}"></label>
                            </div>
                        </div>
                        
                        <div class="tag-header mb-3 pt-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="tag-icon me-3" style="background-color: ${tagData.color};">
                                    <i class="bi bi-tag-fill text-white"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0 fw-bold">${tagData.name}</h5>
                                    <small class="text-muted">‰ΩúÊàê: ${tagData.created_at}</small>
                                </div>
                            </div>
                        </div>
                        
                        ${tagData.description ? `
                            <div class="tag-description mb-3">
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    ${tagData.description}
                                </p>
                            </div>
                        ` : ''}
                        
                        <div class="tag-stats mb-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-primary mb-0">0</h6>
                                        <small class="text-muted">‰∫∫Áâ©</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item border-start border-end">
                                        <h6 class="text-success mb-0">0</h6>
                                        <small class="text-muted">ÁµÑÁπîÈñ¢‰øÇ</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h6 class="text-info mb-0">0</h6>
                                        <small class="text-muted">‰∫∫Áâ©Èñ¢‰øÇ</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="usage-bar mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">‰ΩøÁî®È†ªÂ∫¶</small>
                                <small class="fw-bold">0</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar" style="width: 0%; background-color: ${tagData.color};"></div>
                            </div>
                        </div>
                        
                        <div class="tag-preview mb-3">
                            <span class="tag-sample" style="background-color: ${tagData.color};">
                                <i class="bi bi-tag me-1"></i>${tagData.name}
                            </span>
                        </div>
                        
                        <div class="tag-actions d-flex justify-content-between align-items-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editTagModal" data-tag-id="${tagData.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="filterByTag('${tagData.id}')">
                                    <i class="bi bi-funnel"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="duplicateTag('${tagData.id}')">
                                        <i class="bi bi-files me-2"></i>Ë§áË£Ω
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportTag('${tagData.id}')">
                                        <i class="bi bi-download me-2"></i>„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteTag('${tagData.id}')">
                                        <i class="bi bi-trash me-2"></i>ÂâäÈô§
                                    </a></li>
                                </ul>
                            </div>
                            
                            <div class="usage-indicator">
                                <span class="badge bg-secondary">Êú™‰ΩøÁî®</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        tagsGrid.insertAdjacentHTML('afterbegin', tagHTML);
        
        // Add event listener to new checkbox
        const newCheckbox = document.getElementById(newTagId);
        newCheckbox.addEventListener('change', updateBulkSelection);
        
        // Add hover effect to new card
        const newCard = newCheckbox.closest('.tag-card');
        newCard.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px) scale(1.02)';
            this.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        });
        
        newCard.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    }
    
    function updateStatsAfterCreate() {
        const totalTagsElement = document.querySelector('.stats-card h2');
        const currentCount = parseInt(totalTagsElement.textContent);
        totalTagsElement.textContent = currentCount + 1;
    }
    
    function showSuccessMessage(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3 animate__animated animate__slideInRight';
        alert.style.zIndex = '9999';
        alert.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        
        setTimeout(() => alert.remove(), 5000);
    }
    
    function showErrorMessage(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3 animate__animated animate__slideInRight';
        alert.style.zIndex = '9999';
        alert.innerHTML = `
            <i class="bi bi-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        
        setTimeout(() => alert.remove(), 5000);
    }
    
    function animateStats() {
        // Animate counters
        function animateNumber(element, target) {
            let current = 0;
            const increment = target / 50;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current);
            }, 50);
        }
        
        // Calculate stats from existing tags
        const tagItems = document.querySelectorAll('.tag-item');
        let activeTags = 0;
        let totalUsage = 0;
        
        tagItems.forEach(item => {
            const usage = parseInt(item.dataset.usage);
            if (usage > 0) activeTags++;
            totalUsage += usage;
        });
        
        // Animate the counters
        setTimeout(() => {
            animateNumber(document.getElementById('activeTags'), activeTags);
            animateNumber(document.getElementById('totalUsage'), totalUsage);
        }, 500);
    }
    
    // Enhanced card hover effects
    document.querySelectorAll('.tag-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px) scale(1.02)';
            this.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
    
    // Edit tag modal handling
    document.addEventListener('click', async function(e) {
        if (e.target.closest('[data-bs-target="#editTagModal"]')) {
            const button = e.target.closest('[data-bs-target="#editTagModal"]');
            const tagId = button.dataset.tagId;
            
            try {
                const response = await fetch('/api/tags/' + tagId + '/details/');
                const result = await response.json();
                
                if (result.success) {
                    // Populate edit form
                    populateEditForm(result.tag);
                }
            } catch (error) {
                console.error('Error loading tag details:', error);
                showErrorMessage('„Çø„Ç∞ÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
    });
    
    function populateEditForm(tag) {
        // Edit form population logic would go here
        console.log('Edit tag:', tag);
    }
});

// Global functions for tag actions
async function deleteTag(tagId) {
    if (!confirm('„Åì„ÅÆ„Çø„Ç∞„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºüÈñ¢ÈÄ£‰ªò„Åë„Çâ„Çå„Åü„Éá„Éº„Çø„ÇÇÂ§±„Çè„Çå„Åæ„Åô„ÄÇ')) {
        return;
    }
    
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        const response = await fetch('/api/tags/' + tagId + '/delete/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove from UI
            const tagElement = document.querySelector('input[value="' + tagId + '"]')?.closest('.tag-item');
            if (tagElement) {
                tagElement.classList.add('animate__animated', 'animate__fadeOut');
                setTimeout(() => {
                    tagElement.remove();
                    // Update stats
                    const totalTagsElement = document.querySelector('.stats-card h2');
                    const currentCount = parseInt(totalTagsElement.textContent);
                    totalTagsElement.textContent = currentCount - 1;
                }, 500);
            }
            
            // Show success message function would be here
            console.log('Tag deleted successfully');
        } else {
            alert(result.error || '„Çø„Ç∞„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
    } catch (error) {
        console.error('Error deleting tag:', error);
        alert('„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
    }
}

function filterByTag(tagId) {
    console.log('Filtering by tag:', tagId);
    window.location.href = '/people/?tag=' + tagId;
}

function duplicateTag(tagId) {
    console.log('Duplicating tag:', tagId);
}

function exportTag(tagId) {
    console.log('Exporting tag:', tagId);
}
</script>

<style>
.color-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin: 1px;
}

.color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
}

.tag-color-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.tag-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.tag-sample {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.tag-preview-sample {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    color: white;
    font-weight: 500;
    transition: all 0.3s ease;
}

.color-preset {
    width: 30px;
    height: 30px;
    border: 2px solid #dee2e6;
    border-radius: 50%;
    padding: 0;
    margin: 2px;
    transition: all 0.2s ease;
}

.color-preset:hover {
    transform: scale(1.1);
    border-color: #007bff;
}

.color-preset.active {
    border-color: #007bff;
    border-width: 3px;
    transform: scale(1.1);
}

.stat-item {
    padding: 8px 0;
}

.usage-bar .progress-bar {
    transition: width 0.3s ease;
}

.tag-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.tag-card:hover {
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

.tag-item {
    animation-fill-mode: both;
}

#bulkActionBar {
    animation-fill-mode: both;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    pointer-events: none;
    border-radius: inherit;
}

.stats-card:hover {
    transform: translateY(-5px) scale(1.02);
}
</style>
{% endblock %}